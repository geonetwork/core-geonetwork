<?xml version="1.0" encoding="UTF-8"?>
<geonet>
  <services package="org.fao.geonet">
    <documentation>Statistics services</documentation>
    
    <!--  Note CSV export to a file for statistics tables, through a Jeeves service => 
          all tables data are loaded into memory before their processing -->
    <service name="stat.tableExport">
      <documentation>CSV export for statistics tables</documentation>
      <output sheet="../xslt/services/statistics/to-csv_from_java.xsl"
        contentType="text/plain; charset=UTF-8">
        <call name="statCSV" class=".services.statistics.TableExport">
          <!-- currently the only supported value, (required)  -->
          <param name="exportType" value="CSV"/>
          <!-- The CSV separator (required)  -->
          <param name="csvSeparator" value=";"/>
          <!-- True to write columns (header) informations at the beginning of the file (required),
                         false to dump only data -->
          <param name="dumpHeader" value="true"/>
          <!-- Allowed tables to be exported, separated by commas -->
          <param name="allowedTables" value="requests,params"/>
        </call>
      </output>
    </service>

    <service name="statistics-search">
      <documentation><![CDATA[
            Return main metrics for the catalog and search service. Metrics are:
            
            * activity_days: Number of days of activity
            * activity_months: Number of months of activity
            * total_searches: Total number of searches
            * avg_searches_by_day: Average number of searches by day
            * avg_searches_by_month: Average number of searches by month
            * avg_views_by_day: Average number of metadata record views by day
            * avg_views_by_month: Average number of metadata record views by month
            * total_searches_with_no_hits: Number of searches with no hits
            
            Parameters:
            
            * service: the search service to compute statistics on (eg. service=csw)
            
            URL: http://localhost:8080/geonetwork/srv/eng/statistics-search?service=q
            
            Response:
            
            <response>
              <activity_days>48</activity_days>
              <activity_months>1</activity_months>
              <total_searches>31</total_searches>
              <avg_searches_by_day>0</avg_searches_by_day>
              <avg_searches_by_month>31</avg_searches_by_month>
              <avg_views_by_day>4</avg_views_by_day>
              <avg_views_by_month>219</avg_views_by_month>
              <total_searches_with_no_hits>0</total_searches_with_no_hits>
            </response>
            ]]></documentation>
      <class name=".services.statistics.SearchStatistics"/>
    </service>


    <service name="statistics-search-ip">
      <documentation><![CDATA[
              Service statistics-search-ip
              
              Return unique IP address with number of searches.
              
              URL: http://localhost:8080/geonetwork/srv/eng/statistics-search-ip
              
              Response:
              
              <response>
                <record>
                  <ip>127.0.0.1</ip>
                  <sumhit>1058</sumhit>
                </record>
              </response>
              ]]></documentation>
      <class name="jeeves.services.db.Select">
        <param name="db" value="main-db"/>
        <param name="query"
          value="select ip, count(*) as sumhit from requests where autogenerated = 0 group by ip order by sumhit desc"
        />
      </class>
    </service>

    <service name="statistics-search-by-service-type">
      <documentation><![CDATA[
            Return number of searches per service types.
            
            URL: http://localhost:8080/geonetwork/srv/eng/statistics-search-by-service-type
            
            Response:
            
            <response>
             <record>
                <service>q</service>
                <nbsearch>971</nbsearch>
              </record>
              <record>
                <service>csw</service>
                <nbsearch>31</nbsearch>
              </record>
            </response>
          ]]>
      </documentation>
      <class name="jeeves.services.db.Select">
        <param name="db" value="main-db"/>
        <param name="query"
          value="select service, count(*) as nbsearch from requests group by service order by nbsearch desc"
        />
      </class>
    </service>


    <!-- Search term statistcs -->
    <service name="statistics-search-fields">
      <documentation><![CDATA[
            Return information about which search fields are used by service type.
            
            URL: http://localhost:8080/geonetwork/srv/eng/statistics-search-fields
            
            Response:
            
            <response>
              <record>
                <service>csw</service>
                <termfield>keyword</termfield>
                <total>17</total>
              </record> 
              <record>
                <service>csw</service>
                <termfield>any</termfield>
                <total>6</total>
              </record>
            ...
            ]]></documentation>
      <class name="jeeves.services.db.Select">
        <param name="db" value="main-db"/>
        <param name="query"
          value="select service, termfield, count(*) as total 
                    from params p, requests r 
                    where p.requestid = r.id
                    group by service, termfield order by service, total desc"
        />
      </class>
    </service>

    <!-- Search term statistcs -->
    <service name="statistics-search-terms">
      <documentation><![CDATA[
            Return information about which search terms are used for a field.
            
            URL: http://localhost:8080/geonetwork/srv/eng/statistics-search-terms?field=any&service=q
            
            Parameters:
            
            * field: Lucene search field (eg. field=any)
            * service: the search service to compute statistics on (eg. service=csw)
            
            Response:
            
            <response>
              <record>
                <termtext>africa</termtext>
                <total>6</total>
              </record>
            </response>
            ]]>
      </documentation>
      <class name=".services.statistics.SearchTermsStatistics"/>
    </service>


    <service name="statistics-search-by-date">
      <documentation><![CDATA[
            Number of searches during a date rang
            ]]></documentation>
      <class name=".services.statistics.RequestsByDateStatistics"/>
    </service>

    <!-- Content statistcs -->
    <service name="statistics-content">
      <documentation><![CDATA[
            Return information about the number of metadata records in the catalog:
            
            * nb_metadata: Total number of records
            * nb_harvested: Number of harvested records
            * nb_template: Number of templates
            * nb_subtemplate: Number of directory entries
            * nb_metadata_public: Number of public metadata records
            
            URL: http://localhost:8080/geonetwork/srv/eng/statistics-content
            
            Response:
            
            <response>
              <nb_metadata>106</nb_metadata>
              <nb_harvested>59</nb_harvested>
              <nb_template>11</nb_template>
              <nb_subtemplate>2</nb_subtemplate>
              <nb_metadata_public>0</nb_metadata_public>
            </response>
]]>
      </documentation>
      <class name=".services.statistics.ContentStatistics"/>
    </service>

    <service name="statistics-content-metadata">
      <documentation><![CDATA[
            Return statistics by type of records.
            
            Parameters:
            
            * by: Type of records
            * schema: By metadata standards
            * category: By category
            * template: By metadata type
            * harvest: Harvested or not
            * source: By source catalog
            * status: By metadata status
            * validity: By metadata validation status
            * owner: By owner
            * groupowner: By group owner
            * isTemplate: To return information for template (ie. "y"), metadata (ie "n"), directory entry (ie. "s") or all "%"
            
            URL: http://localhost:8080/geonetwork/srv/eng/statistics-content-metadata?by=schema&isTemplate=n
            
            Response:
            
            <response>
                <record>
                    <label>iso19139</label>
                    <total>97</total>
                </record>
                <record>
                    <label>dublin-core</label>
                    <total>3</total>
                </record>
                <record>
                    <label>fgdc-std</label>
                    <total>3</total>
                </record>
                <record>
                    <label>iso19115</label>
                    <total>3</total>
                </record>
            </response>
            ]]></documentation>
      <class name=".services.statistics.MetadataStatistics"/>
    </service>
  </services>
</geonet>
